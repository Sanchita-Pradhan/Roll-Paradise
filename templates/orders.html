{% extends "base.html" %}
{% block title %}My Orders - Roll Paradise{% endblock %}

{% block content %}
<!-- Orders Hero Section -->
<section class="orders-hero animated-hero-bg">
  <div class="container hero-content" style="padding: 5rem 0 3rem 0; text-align:center; position:relative; z-index:2;">
    <div class="hero-badge" style="margin-bottom:2rem;">
      <span class="badge-icon" style="font-size:1.3rem;">üßæ</span>
      YOUR ORDERS
    </div>
    <h1 class="hero-title" style="font-size:3.5rem; font-weight:900; color:white; text-shadow:2px 2px 8px rgba(102,126,234,0.15); animation:fadeInDown 1.2s;">
      Track &amp; Manage Orders
    </h1>
    <p class="hero-subtitle" style="color:#f8f9ff; font-size:1.25rem; margin:1.5rem auto 2.5rem; max-width:600px; animation:fadeInUp 1.2s;">
      View your recent orders, track delivery status, and reorder your favorites with ease!
    </p>
    <div class="hero-features" style="margin:2.5rem 0 1rem 0;">
      <div class="feature-item" style="animation: popIn 1s 0.2s both;">
        <i class="fas fa-truck"></i>
        Live Tracking
      </div>
      <div class="feature-item" style="animation: popIn 1s 0.4s both;">
        <i class="fas fa-history"></i>
        Order History
      </div>
      <div class="feature-item" style="animation: popIn 1s 0.6s both;">
        <i class="fas fa-redo"></i>
        Quick Reorder
      </div>
    </div>
  </div>
  <!-- Animated floating icons -->
  <div class="floating-foods">
    <span class="floating-food food-1">üßæ</span>
    <span class="floating-food food-2">ü•°</span>
    <span class="floating-food food-3">üöö</span>
    <span class="floating-food food-4">üçΩÔ∏è</span>
    <span class="floating-food food-5">üïí</span>
    <span class="floating-food food-6">‚≠ê</span>
  </div>
  <!-- Animated bubbles background -->
  <div class="bubbles-bg">
    {% for i in range(12) %}
      <div class="bubble" style="left:{{ (i*8)%100 }}%; animation-delay: {{ (i*0.3)|round(2) }}s;"></div>
    {% endfor %}
  </div>
</section>

<!-- Latest Order Map Section -->
<section class="latest-order-map-section" style="background:var(--light-lavender);padding:2rem 0;">
  <div class="container" style="display:flex;flex-wrap:wrap;align-items:center;gap:2rem;">
    <div style="flex:1;min-width:320px;">
      <h2 style="font-size:2rem;font-weight:700;color:var(--primary-purple);margin-bottom:0.5rem;">
        Latest Order Location
      </h2>
      <p style="color:#555;margin-bottom:1rem;">
        See where your latest order is right now!
      </p>
      <div id="latestOrderStatus" style="font-size:1.1rem;color:var(--dark-purple);margin-bottom:1rem;"></div>
    </div>
    <div style="flex:1;min-width:320px;">
      <div id="orderMap" style="width:100%;height:320px;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.08);border:2px solid #e6e8ff;overflow:hidden;"></div>
    </div>
  </div>
</section>

<!-- Orders List Section -->
<section class="orders-section" style="background:var(--creamy-white);padding:3rem 0;">
  <div class="container">
    <div id="ordersList" class="orders-list animated-list">
      <div class="loading-orders shimmer">
        <div class="loading-spinner"></div>
        <p>Loading orders...</p>
      </div>
    </div>
    <!-- Empty State -->
    <div id="emptyOrdersAnim" class="empty-orders-anim" style="display:none;">
      <div class="empty-emoji bounce" style="font-size:3rem;">üåØ</div>
      <div class="empty-text" style="color:#888;font-size:1.2rem;">No orders found.<br>Start your flavor adventure!</div>
      <a href="/menu" class="btn btn-primary empty-btn" style="margin-top:1.5rem;">Order Now</a>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
/* Hero and Animations */
.animated-hero { animation: fadeIn 1.2s; }
@keyframes fadeIn { from { opacity:0; transform:translateY(-30px);} to { opacity:1; transform:translateY(0);} }
@keyframes fadeInDown { from { opacity:0; transform:translateY(-40px);} to { opacity:1; transform:translateY(0);} }
@keyframes fadeInUp { from { opacity:0; transform:translateY(40px);} to { opacity:1; transform:translateY(0);} }
@keyframes bounceIn {
  0% { transform: scale(0.5); opacity: 0; }
  60% { transform: scale(1.2); opacity: 1; }
  80% { transform: scale(0.95);}
  100% { transform: scale(1);}
}
.bounce { animation: bounceIn 1.2s; }

.floating-icons-bg {
  position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;
}
.floating-icons-bg span {
  position:absolute;
  font-size:2.5rem;
  opacity:0.08;
  animation: floatY 4s ease-in-out infinite alternate;
}
@keyframes floatY {
  from { transform: translateY(0);}
  to { transform: translateY(-20px);}
}

/* Animated bubbles background */
.bubbles-bg {
  position: absolute;
  left: 0; top: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 0;
}
.bubble {
  position: absolute;
  bottom: -60px;
  width: 32px; height: 32px;
  background: rgba(255,255,255,0.13);
  border-radius: 50%;
  animation: bubbleUp 8s linear infinite;
}
@keyframes bubbleUp {
  0% { transform: translateY(0) scale(1);}
  80% { opacity: 1;}
  100% { transform: translateY(-600px) scale(1.2); opacity: 0;}
}

/* Order Filters */
.order-filters {
  margin-bottom: 2rem;
}
.order-filter-btn {
  background: rgba(255,255,255,0.15);
  color: #fff;
  border: none;
  border-radius: 25px;
  padding: 0.6rem 1.5rem;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.2s, color 0.2s, transform 0.2s;
  box-shadow: 0 2px 8px rgba(102,126,234,0.08);
}
.order-filter-btn.active,
.order-filter-btn:hover {
  background: var(--button-gradient);
  color: #fff;
  transform: scale(1.08);
}

/* Latest Order Map Section */
.latest-order-map-section {
  background: var(--light-lavender);
  border-bottom: 1px solid #e6e8ff;
  margin-bottom: 2rem;
  animation: fadeIn 1.2s;
}
#orderMap {
  min-height: 280px;
  background: #e6e8ff;
  border-radius: 18px;
  box-shadow: 0 4px 24px rgba(102, 126, 234, 0.08);
  border: 2px solid #e6e8ff;
  transition: box-shadow 0.2s;
}
#orderMap:empty::after {
  content: "Loading map...";
  color: #888;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  font-size: 1.2rem;
}
@media (max-width: 900px) {
  .latest-order-map-section .container {
    flex-direction: column;
  }
}

/* Orders List & Cards */
.orders-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 2rem;
}
.order-card {
  background: white;
  border-radius: 18px;
  box-shadow: 0 4px 24px rgba(102, 126, 234, 0.08);
  padding: 2rem;
  border: 1px solid #e9ecef;
  position: relative;
  animation: fadeInUp 0.6s;
  transition: box-shadow 0.2s, transform 0.2s;
  will-change: transform;
}
.order-card:hover {
  box-shadow: 0 8px 32px rgba(102, 126, 234, 0.16);
  transform: translateY(-8px) scale(1.025);
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(30px);}
  to { opacity: 1; transform: translateY(0);}
}
.order-header {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 1.5rem;
  margin-bottom: 1rem;
}
.order-id {
  font-weight: 600;
  color: var(--primary-purple);
}
.order-date {
  color: #888;
  font-size: 0.95rem;
}
.status-badge {
  padding: 0.3rem 1rem;
  border-radius: 20px;
  font-size: 0.95rem;
  font-weight: 600;
  margin-left: auto;
}
.status-pending { background: #fff3cd; color: #856404; }
.status-delivered { background: #d4edda; color: #155724; }
.status-cancelled { background: #f8d7da; color: #721c24; }
.status-processing { background: #d1ecf1; color: #0c5460; }
.order-items ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.order-items li {
  display: flex;
  justify-content: space-between;
  padding: 0.3rem 0;
  border-bottom: 1px solid #f1f1f1;
  font-size: 1rem;
}
.order-items .qty {
  color: #888;
  margin-left: 0.5rem;
}
.order-items .price {
  color: var(--primary-purple);
  font-weight: 600;
  margin-left: 1rem;
}
.order-summary {
  margin-top: 1rem;
  font-size: 1.05rem;
}
.order-footer {
  margin-top: 1rem;
  color: #888;
  font-size: 0.95rem;
}

/* Loading shimmer */
.loading-orders.shimmer {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 200px;
  position: relative;
  overflow: hidden;
}
.loading-orders.shimmer::before {
  content: '';
  position: absolute;
  top:0; left:0; right:0; bottom:0;
  background: linear-gradient(90deg, #f8f9ff 0%, #e6e8ff 50%, #f8f9ff 100%);
  opacity: 0.5;
  animation: shimmer 1.5s infinite linear;
  z-index: 1;
}
@keyframes shimmer {
  0% { transform: translateX(-100%);}
  100% { transform: translateX(100%);}
}
.loading-spinner {
  width: 36px; height: 36px;
  border: 4px solid #e6e8ff;
  border-top: 4px solid var(--primary-purple);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 1rem;
  z-index: 2;
}
@keyframes spin {
  to { transform: rotate(360deg);}
}

/* Empty state bounce */
.empty-emoji.bounce {
  animation: bounceIn 1.2s;
}
.empty-orders-anim {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 300px;
  color: #888;
  font-size: 1.2rem;
}
.empty-btn {
  margin-top: 1.5rem;
}
</style>
{% endblock %}

{% block extra_js %}
<style>
.animated-hero-bg {
  background: linear-gradient(120deg, #6a82fb 0%, #fc5c7d 100%);
  background-size: 200% 200%;
  animation: gradientMove 10s ease-in-out infinite;
  position: relative;
  overflow: hidden;
}
@keyframes gradientMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
.floating-foods {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none;
  z-index: 1;
}
.floating-food {
  position: absolute;
  font-size: 2.5rem;
  opacity: 0.18;
  animation: floatFood 8s ease-in-out infinite;
}
.food-1 { left: 10%; top: 20%; animation-delay: 0s; }
.food-2 { left: 80%; top: 30%; animation-delay: 1.5s; }
.food-3 { left: 20%; top: 70%; animation-delay: 3s; }
.food-4 { left: 60%; top: 80%; animation-delay: 4.5s; }
.food-5 { left: 40%; top: 10%; animation-delay: 2s; }
.food-6 { left: 70%; top: 60%; animation-delay: 5.5s; }
@keyframes floatFood {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-30px) scale(1.1); }
}
.bubbles-bg {
  position: absolute;
  left: 0; top: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 0;
}
.bubble {
  position: absolute;
  bottom: -60px;
  width: 32px; height: 32px;
  background: rgba(255,255,255,0.13);
  border-radius: 50%;
  animation: bubbleUp 8s linear infinite;
}
@keyframes bubbleUp {
  0% {
    transform: translateY(0) translateX(0) scale(1);
    opacity: 0.7;
  }
  30% {
    opacity: 1;
  }
  50% {
    transform: translateY(-300px) translateX(20px) scale(1.1);
  }
  75% {
    transform: translateY(-500px) translateX(-20px) scale(1.15);
  }
  100% {
    transform: translateY(-600px) translateX(0) scale(1.2);
    opacity: 0;
  }
}
.hero-features {
  display: flex;
  justify-content: center;
  gap: 2rem;
  margin: 2rem 0 1rem 0;
}
.feature-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  color: var(--primary-purple);
  font-weight: 600;
  font-size: 1.1rem;
  background: rgba(255,255,255,0.7);
  border-radius: 12px;
  padding: 1rem 1.5rem;
  box-shadow: var(--shadow-soft);
  transition: all 0.3s;
  opacity: 0;
}
.feature-item i {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
  color: var(--secondary-purple);
}
.feature-item:hover {
  background: var(--card-gradient);
  color: var(--secondary-purple);
  transform: translateY(-4px) scale(1.05);
  box-shadow: var(--shadow-medium);
}
@keyframes popIn {
  0% { opacity: 0; transform: scale(0.7) translateY(30px);}
  100% { opacity: 1; transform: scale(1) translateY(0);}
}
@media (max-width: 900px) {
  .hero-features {
    flex-direction: column;
    gap: 1rem;
  }
  .hero-title {
    font-size: 2.2rem !important;
  }
}
</style>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZ_zJYD7RbAOfExy2Vf4iYT1bBfnY5hpI"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ordersList = document.getElementById('ordersList');
    const emptyAnim = document.getElementById('emptyOrdersAnim');
    const filterBtns = document.querySelectorAll('.order-filter-btn');
    let allOrders = [];
    let last4Orders = [];

    // Fetch orders from backend
    fetch('/api/get-orders')
      .then(res => res.json())
      .then(data => {
        if (data.success && data.orders && data.orders.length > 0) {
          allOrders = data.orders.slice().sort((a, b) => new Date(b.order_date) - new Date(a.order_date));
          last4Orders = allOrders.slice(0, 4);
          renderOrders(last4Orders);
          showLatestOrderMap(last4Orders);
          ordersList.style.display = '';
          emptyAnim.style.display = 'none';
        } else {
          ordersList.style.display = 'none';
          emptyAnim.style.display = 'flex';
        }
      })
      .catch(() => {
        ordersList.style.display = 'none';
        emptyAnim.style.display = 'flex';
      });

    // Render orders (accepts an array)
    function renderOrders(orderArray) {
      ordersList.innerHTML = '';
      emptyAnim.style.display = orderArray.length ? 'none' : 'flex';
      if (!orderArray.length) {
        ordersList.style.display = 'none';
        return;
      }
      ordersList.style.display = '';
      orderArray.forEach((order, idx) => {
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card animated-card';
        orderCard.style.animationDelay = (idx * 0.08) + 's';
        orderCard.innerHTML = `
          <div class="order-header">
            <div class="order-id">Order <b>#${order.order_id}</b></div>
            <div class="order-date">${new Date(order.order_date).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' })}</div>
            <span class="status-badge status-${order.status}">
              ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
            </span>
          </div>
          <div class="order-items">
            <h4>Items:</h4>
            <ul>
              ${(order.items || []).map(item => `<li>${item.name} <span class="qty">x${item.quantity}</span> <span class="price">‚Çπ${(item.price * item.quantity).toFixed(2)}</span></li>`).join('')}
            </ul>
          </div>
          <div class="order-summary">
            <span>Subtotal: <b>‚Çπ${(order.subtotal || 0).toFixed(2)}</b></span><br/>
            <span>Delivery Fee: <b>‚Çπ${(order.delivery_fee || 0).toFixed(2)}</b></span><br/>
            <span>Total: <b>‚Çπ${(order.total || 0).toFixed(2)}</b></span>
          </div>
          <div class="order-footer">
            <span>Estimated Delivery: ${order.estimated_delivery ? new Date(order.estimated_delivery).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) : ''}</span>
          </div>
        `;
        ordersList.appendChild(orderCard);
      });
    }

    // Show orders on Google Map (accepts an array)
    function showLatestOrderMap(orderArray) {
      const mapDiv = document.getElementById('orderMap');
      const statusDiv = document.getElementById('latestOrderStatus');
      mapDiv.innerHTML = "";

      const ordersWithLocation = orderArray.filter(o => o.location && o.location.lat && o.location.lng);
      if (!ordersWithLocation.length) {
        mapDiv.innerHTML = "<div style='padding:2rem;text-align:center;color:#888;'>No location available for your orders.</div>";
        statusDiv.textContent = "";
        return;
      }

      const latest = ordersWithLocation[0];
      mapDiv.style.height = '320px';

      const map = new google.maps.Map(mapDiv, {
        center: { lat: latest.location.lat, lng: latest.location.lng },
        zoom: 12,
        disableDefaultUI: true,
        styles: [
          { featureType: "poi", stylers: [{ visibility: "off" }] },
          { featureType: "transit", stylers: [{ visibility: "off" }] }
        ]
      });

      ordersWithLocation.forEach(order => {
        const marker = new google.maps.Marker({
          position: { lat: order.location.lat, lng: order.location.lng },
          map,
          animation: google.maps.Animation.DROP,
          title: `Order #${order.order_id}`
        });

        const infowindow = new google.maps.InfoWindow({
          content: `
            <b>Order #${order.order_id}</b><br>
            Status: <b>${order.status ? order.status.charAt(0).toUpperCase() + order.status.slice(1) : ''}</b><br>
            Total: ‚Çπ${(order.total || 0).toFixed(2)}<br>
            Placed: ${order.order_date ? new Date(order.order_date).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) : ''}
          `
        });

        marker.addListener("click", () => {
          infowindow.open(map, marker);
        });

        if (order.order_id === latest.order_id) {
          infowindow.open(map, marker);
        }
      });

      statusDiv.innerHTML = `
        <b>${ordersWithLocation.length} order(s) shown.</b><br>
        Latest: <b>Order #${latest.order_id}</b> is <span style="color:var(--primary-purple);font-weight:600;">${latest.status ? latest.status.charAt(0).toUpperCase() + latest.status.slice(1) : ''}</span>
        <br>
        Last updated: ${latest.order_date ? new Date(latest.order_date).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) : ''}
      `;
    }

    // Example: If you have a button with id="showAllOrdersBtn" for "Order History"
    const showAllOrdersBtn = document.getElementById('showAllOrdersBtn');
    if (showAllOrdersBtn) {
      showAllOrdersBtn.addEventListener('click', function() {
        renderOrders(allOrders);
        showLatestOrderMap(allOrders);
      });
    }
  });
</script>
{% endblock %}